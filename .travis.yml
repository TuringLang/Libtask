language: julia

os:
- linux
- osx

julia:
- 0.7
- 1.0
- nightly

matrix:
  allow_failures:
  - julia: nightly
  - julia: 0.7
  fast_finish: true

  notifications:
  email: false

stages:
- name: dylib
- name: test

jobs:
  include:
  - stage: dylib
    julia: 1.0
    script:
    - julia -e 'using Pkg; Pkg.add("BinaryProvider"); Pkg.add("BinaryBuilder");'
    - julia deps/build_tarballs.jl
    deploy:
      provider: releases
      api_key:
        secure: pDVeQtN4VOE6MnJBRHZRGxoYqM5k4ylUow6NbRlqjZrVqrJ7pAw5yh5+HTvZJSIrTHN0/jauSN0a48mbwRaWFRg/pIYRNeMtb2euRrF9MvasG33sYvCiEZPmOLfOb65Vm9OG5rptK9qgq4fK0NscduH+0c0bVC7AtHSVbJp4UfO3zinF52T4X5I2+udJ8AfZh+UXlt51q7rYsUqGRrD6F57rarug4Z4S97hsXgMBnGiuYAwUtfMfRuCTS5GtWeAmGEZu/cINRZi0+jY5PjWNM9wuxdba9U/tsdDCF0lifnkdP0bAZ0xCSdul0SWc06pIr11k4yYTPirVhstWwqqUOAaElDw+6LrtUA+arzV0o3rFanR3wscew84ds/M12tOcHcREMuCIBzPVx/Kv71DZRyCpAmZsn+dsva0VHBwz9GUiWF/eEhy3c+l6yZUiA4ZPXDZodFOODxBdvwjdWPHr/umF3BoBiiAmqs954Gcw032Uo+z0YxW/tTwmdcKBq0wQwnP1PUC2GmPk0KU7XKlmz0JCfIsZGgxyNblVhabpv7L9lasLHMDg67x5AMVMIPgORPHZIwnPjB1cueALWMBkP4d4ERlWaOlSgKR2w05Xs0vH+o1EJD8kmjo3TV+6u8hiTn1EZXt777lqXFlDoX4+ocazTY+Um3rUzuMj0Sr5ktM=
      file_glob: true
      skip_cleanup: true
      file: products/*
      on:
        repo: TuringLang/Libtask.jl
        tags: true
  - stage: test
    script:
    - if [[ -a .git/shallow ]]; then git fetch --unshallow; fi
    - julia -e ' using Pkg; Pkg.clone(pwd(), "Libtask"); Pkg.build("Libtask"); Pkg.test("Libtask"; coverage=true)'
    - julia -e ' using Pkg; cd(Pkg.dir("Libtask")); Pkg.add("Coverage"); using Coverage; Coveralls.submit(process_folder())'
